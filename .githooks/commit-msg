#!/usr/bin/env bash
set -euo pipefail
# Commit-msg hook to enforce package.json and APKBUILD rules
# Usage: install by running: git config core.hooksPath scripts/git-hooks

MSG_FILE="$1"
MSG_CONTENT=$(cat "$MSG_FILE" || true)

SKIP_VERSION=false
SKIP_APK=false
echo "$MSG_CONTENT" | grep -F '[skip-version-name-check]' >/dev/null 2>&1 && SKIP_VERSION=true
echo "$MSG_CONTENT" | grep -F '[skip-apkbuild-check]' >/dev/null 2>&1 && SKIP_APK=true

echo "[commit-msg] Running commit-msg hook checks..." >&2

get_index_file() {
  # Return staged (index) version of a file if available, else fall back to worktree file
  path="$1"
  git show ":$path" 2>/dev/null || cat "$path" 2>/dev/null || true
}

# Determine if package.json is staged/changed
STAGED_FILES=$(git diff --cached --name-only || true)

if echo "$STAGED_FILES" | grep -qx "package.json"; then
  if [ "$SKIP_VERSION" = false ]; then
    v_head=$(git show HEAD:package.json 2>/dev/null | python3 - <<'PY'
import sys, json
try:
    print(json.load(sys.stdin).get('version',''))
except Exception:
    print('')
PY
)
    v_index=$(git show :package.json 2>/dev/null | python3 - <<'PY'
import sys, json
try:
    print(json.load(sys.stdin).get('version',''))
except Exception:
    print('')
PY
)
    n_head=$(git show HEAD:package.json 2>/dev/null | python3 - <<'PY'
import sys, json
try:
    print(json.load(sys.stdin).get('name',''))
except Exception:
    print('')
PY
)
    n_index=$(git show :package.json 2>/dev/null | python3 - <<'PY'
import sys, json
try:
    print(json.load(sys.stdin).get('name',''))
except Exception:
    print('')
PY
)

    if [ "$v_head" != "$v_index" ] || [ "$n_head" != "$n_index" ]; then
      echo "[commit-msg] ERROR: 'package.json' 'version' or 'name' was changed in this commit." >&2
      echo "[commit-msg] If this is intentional, include [skip-version-name-check] in the commit message to bypass." >&2
      exit 1
    fi
  fi
fi

# APKBUILD check (always verify unless explicitly skipped)
APK_PATH="alpine/package/modbus2mqtt/APKBUILD"
apk_content=$(get_index_file "$APK_PATH")
if [ -z "$apk_content" ] && [ -f "$APK_PATH" ]; then
  apk_content=$(cat "$APK_PATH")
fi

if [ "$SKIP_APK" = false ]; then
  echo "$apk_content" | grep -F 'npmpackage="${pkgname}"' >/dev/null 2>&1 || {
    echo "[commit-msg] ERROR: $APK_PATH must contain the line: npmpackage=\"\
\${pkgname}\"" >&2
    echo "[commit-msg] If you intentionally want to skip this check, include [skip-apkbuild-check] in the commit message." >&2
    exit 1
  }
fi

# ESLint check for all staged files
if command -v npx >/dev/null 2>&1; then
  ESLINT_ERRORS=0
  for file in $STAGED_FILES; do
    # Check only relevant file types
    case "$file" in
      *.js|*.ts|*.tsx|*.jsx)
        echo "Running ESLint on $file..."
        npx eslint "$file" || ESLINT_ERRORS=1
        ;;
    esac
  done
  if [ "$ESLINT_ERRORS" -ne 0 ]; then
    echo "[commit-msg] ERROR: ESLint found problems in staged files. Commit aborted." >&2
    exit 1
  fi
fi

echo "[commit-msg] Commit-msg checks passed." >&2
exit 0
