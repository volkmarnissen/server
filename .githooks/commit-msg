#!/usr/bin/env bash
set -euo pipefail
# Commit-msg hook to enforce package.json and APKBUILD rules
# Usage: install by running: git config core.hooksPath .githooks

MSG_FILE="$1"
MSG_CONTENT=$(cat "$MSG_FILE" || true)

SKIP_VERSION=false
SKIP_APK=false
echo "$MSG_CONTENT" | grep -F '[skip-version-name-check]' >/dev/null 2>&1 && SKIP_VERSION=true
echo "$MSG_CONTENT" | grep -F '[skip-apkbuild-check]' >/dev/null 2>&1 && SKIP_APK=true

echo "Running commit-msg hook checks..."

get_index_file() {
  # Return staged (index) version of a file if available, else fall back to worktree file
  path="$1"
  git show ":$path" 2>/dev/null || cat "$path" 2>/dev/null || true
}

# Determine if package.json is staged/changed
STAGED_FILES=$(git diff --cached --name-only || true)

if echo "$STAGED_FILES" | grep -qx "package.json"; then
  if [ "$SKIP_VERSION" = false ]; then
  # Safely capture package.json from HEAD (if present) and from the index, then parse with python
  v_head_json=$(git show HEAD:package.json 2>/dev/null || true)
  v_index_json=$(git show :package.json 2>/dev/null || true)

  if [ -n "$v_head_json" ]; then
    v_head=$(printf '%s' "$v_head_json" | python3 -c 'import sys, json
data=sys.stdin.read()
try:
  print(json.loads(data).get("version",""))
except Exception:
  print("")') || true
    n_head=$(printf '%s' "$v_head_json" | python3 -c 'import sys, json
data=sys.stdin.read()
try:
  print(json.loads(data).get("name",""))
except Exception:
  print("")') || true
  else
    v_head=""
    n_head=""
  fi

  if [ -n "$v_index_json" ]; then
    v_index=$(printf '%s' "$v_index_json" | python3 -c 'import sys, json
data=sys.stdin.read()
try:
  print(json.loads(data).get("version",""))
except Exception:
  print("")') || true
    n_index=$(printf '%s' "$v_index_json" | python3 -c 'import sys, json
data=sys.stdin.read()
try:
  print(json.loads(data).get("name",""))
except Exception:
  print("")') || true
  else
    v_index=""
    n_index=""
  fi

    if [ "$v_head" != "$v_index" ] || [ "$n_head" != "$n_index" ]; then
      echo "ERROR: 'package.json' 'version' or 'name' was changed in this commit."
      echo "If this is intentional, include [skip-version-name-check] in the commit message to bypass."
      exit 1
    fi
  fi
fi

# APKBUILD check (always verify unless explicitly skipped)
APK_PATH="alpine/package/modbus2mqtt/APKBUILD"
apk_content=$(get_index_file "$APK_PATH")
if [ -z "$apk_content" ] && [ -f "$APK_PATH" ]; then
  apk_content=$(cat "$APK_PATH")
fi

if [ "$SKIP_APK" = false ]; then
  echo "$apk_content" | grep -F 'npmpackage="${pkgname}"' >/dev/null 2>&1 || {
    echo "ERROR: $APK_PATH must contain the line: npmpackage=\"\\\${pkgname}\""
    echo "If you intentionally want to skip this check, include [skip-apkbuild-check] in the commit message."
    exit 1
  }
fi

echo "Commit-msg checks passed."
exit 0
