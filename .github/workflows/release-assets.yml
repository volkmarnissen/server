name: Build Release Assets

on:
  workflow_call:
    inputs:
      version:
        description: 'Version (without leading v). If omitted, read from package.json.'
        required: false
        type: string
      dry_run:
        description: 'Skip pushing image and uploading release assets when true.'
        required: false
        type: boolean
    outputs:
      resolved_version:
        description: 'Resolved version used for tagging.'
        value: ${{ jobs.prepare.outputs.resolved_version }}
      image_tag:
        description: 'Docker image tag (v<version>).'
        value: ${{ jobs.docker.outputs.image_tag }}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      resolved_version: ${{ steps.setver.outputs.resolved_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version
        id: setver
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "resolved_version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            PKG_VERSION=$(python3 -c "import json;print(json.load(open('package.json'))['version'])")
            echo "resolved_version=$PKG_VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Using version: $(cat $GITHUB_OUTPUT)"

  build_apks:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bash

      - name: Build APK (x86_64 test + aarch64 prod)
        run: |
          set -eux
          # x86_64 test build (quick validation)
          (cd alpine/package/modbus2mqtt && ./build-and-test-image.sh || (echo 'Test image build failed'; exit 1))
          # aarch64 production build (example placeholder)
          echo 'Would run aarch64 build here (abuild -r)'

      - name: Upload APK artifacts
        if: ${{ !inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: apks-${{ needs.prepare.outputs.resolved_version }}
          path: |
            alpine/package/modbus2mqtt/*.apk
            alpine/package/modbus2mqtt/packager.rsa.pub
          if-no-files-found: warn

  docker:
    runs-on: ubuntu-latest
    needs: prepare
    outputs:
      image_tag: v${{ needs.prepare.outputs.resolved_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: ${{ !inputs.dry_run }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build (and optionally push) multi-arch image
        id: buildimage
        env:
          VERSION: ${{ needs.prepare.outputs.resolved_version }}
        run: |
          set -eux
          TAG="ghcr.io/${{ github.repository }}:v${VERSION}"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            # Dry run: build a single-arch image and load into local Docker to sanity-check
            docker buildx build --platform linux/amd64 -t "$TAG" --progress plain --load .
          else
            docker buildx build --platform linux/amd64,linux/arm64 -t "$TAG" --progress plain --push .
          fi
          echo "Built image $TAG"

  attach_release_assets:
    runs-on: ubuntu-latest
    needs: [prepare, build_apks, docker]
    if: ${{ !inputs.dry_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: apks-${{ needs.prepare.outputs.resolved_version }}
          path: apks

      - name: Upload to existing Release (if exists)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.resolved_version }}
          files: |
            apks/*.apk
            apks/packager.rsa.pub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Notes:
# - dry_run=true allows local verification without pushing image or release assets.
# - aarch64 build placeholder should be replaced by real abuild invocation.
# - This workflow is designed to be called from a publish workflow after version bump.
