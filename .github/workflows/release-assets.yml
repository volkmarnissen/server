name: Build Release Assets

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (without leading v). If omitted, read from package.json.'
        required: false
        type: string
      dry_run:
        description: 'Skip pushing image and uploading release assets when true.'
        required: false
        type: boolean  workflow_call:
    inputs:
      version:
        description: 'Version (without leading v). If omitted, read from package.json.'
        required: false
        type: string
      dry_run:
        description: 'Skip pushing image and uploading release assets when true.'
        required: false
        type: boolean
    outputs:
      resolved_version:
        description: 'Resolved version used for tagging.'
        value: ${{ jobs.prepare.outputs.resolved_version }}
      image_tag:
        description: 'Docker image tag (v<version>).'
        value: ${{ jobs.docker.outputs.image_tag }}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      resolved_version: ${{ steps.setver.outputs.resolved_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version
        id: setver
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "resolved_version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            PKG_VERSION=$(python3 -c "import json;print(json.load(open('package.json'))['version'])")
            echo "resolved_version=$PKG_VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Using version: $(cat $GITHUB_OUTPUT)"

  build_apks:
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        arch: [x86_64, aarch64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU for cross-compilation
        if: matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bash

      - name: Build APK for ${{ matrix.arch }}
        env:
          ALPINE_ARCH: ${{ matrix.arch }}
          PACKAGER_PRIVKEY: ${{ secrets.PACKAGER_PRIVKEY }}
        run: |
          set -eux
          cd alpine/package/modbus2mqtt
          # For aarch64, use QEMU to run the Alpine container on arm64
          if [ "$ALPINE_ARCH" = "aarch64" ]; then
            # Build APK only (skip Docker test on emulated arch for speed)
            ./build.sh
          else
            # For x86_64, run full build-and-test including Docker validation
            ./build-and-test-image.sh
          fi

      - name: Upload APK artifacts for ${{ matrix.arch }}
        if: ${{ !inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: apks-${{ matrix.arch }}-${{ needs.prepare.outputs.resolved_version }}
          path: |
            alpine/repo/${{ matrix.arch }}/*.apk
            alpine/repo/${{ matrix.arch }}/packager.rsa.pub
          if-no-files-found: warn

  docker:
    runs-on: ubuntu-latest
    needs: [prepare, build_apks]
    outputs:
      image_tag: v${{ needs.prepare.outputs.resolved_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all APK artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: apks-*-${{ needs.prepare.outputs.resolved_version }}
          path: downloaded-apks

      - name: Organize APKs by architecture
        run: |
          mkdir -p alpine/repo
          # Move artifacts from their subdirectories to alpine/repo/<arch>/
          for artifact_dir in downloaded-apks/apks-*; do
            if [ -d "$artifact_dir" ]; then
              ARCH=$(basename "$artifact_dir" | sed 's/apks-\(.*\)-[0-9].*/\1/')
              echo "Processing architecture: $ARCH"
              mkdir -p "alpine/repo/$ARCH"
              cp -r "$artifact_dir"/* "alpine/repo/$ARCH/" || true
            fi
          done
          ls -lR alpine/repo

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: amd64,arm64

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        if: ${{ !inputs.dry_run }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build (and optionally push) multi-arch image
        id: buildimage
        env:
          VERSION: ${{ needs.prepare.outputs.resolved_version }}
        run: |
          set -eux
          TAG="ghcr.io/${{ github.repository }}:v${VERSION}"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            # Dry run: build a single-arch image and load into local Docker to sanity-check
            docker buildx build \
              --platform linux/amd64 \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              -t "$TAG" \
              --progress plain \
              --load \
              .
          else
            # Production: build and push multi-arch with layer caching
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              -t "$TAG" \
              --progress plain \
              --push \
              .
          fi
          echo "Built image $TAG"

  attach_release_assets:
    runs-on: ubuntu-latest
    needs: [prepare, build_apks, docker]
    if: ${{ !inputs.dry_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all APK artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: apks-*-${{ needs.prepare.outputs.resolved_version }}
          path: apks

      - name: Flatten APK artifacts for upload
        run: |
          mkdir -p release-apks
          find apks -type f \( -name "*.apk" -o -name "packager.rsa.pub" \) -exec cp {} release-apks/ \;
          ls -lh release-apks/

      - name: Upload to existing Release (if exists)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.resolved_version }}
          files: release-apks/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Notes:
# - dry_run=true allows local verification without pushing image or release assets.
# - Multi-arch APK builds (x86_64 + aarch64) use QEMU for cross-compilation.
# - Docker image builds with strict signature verification (no untrusted fallback).
# - This workflow is designed to be called from a publish workflow after version bump.
