name: Build Release Assets

on:
  workflow_call:
    inputs:
      version:
        description: 'Version (without leading v). If omitted, read from package.json.'
        required: false
        type: string
    outputs:
      resolved_version:
        description: 'Resolved version used for tagging.'
        value: ${{ jobs.prepare.outputs.resolved_version }}
      image_tag:
        description: 'Docker image tag (v<version>).'
        value: ${{ jobs.docker.outputs.image_tag }}
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (without leading v). If omitted, read from package.json.'
        required: false
        type: string
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      resolved_version: ${{ steps.setver.outputs.resolved_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version
        id: setver
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "resolved_version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            PKG_VERSION=$(python3 -c "import json;print(json.load(open('package.json'))['version'])")
            echo "resolved_version=$PKG_VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Using version: $(cat $GITHUB_OUTPUT)"


attach_release_assets:
  runs-on: ubuntu-latest
  needs: [prepare, build_apks, create_multiarch_manifest]
  steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Download all APK artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: apks-*-${{ needs.prepare.outputs.resolved_version }}
        path: apks
    - name: Download packager.rsa.pub artifact
      uses: actions/download-artifact@v4
      with:
        name: packager-rsa-pub-${{ needs.prepare.outputs.resolved_version }}
        path: release-apks/
    - name: Flatten APK artifacts for upload
      run: |
        mkdir -p release-apks
        find apks -type f \( -name "*.apk" -o -name "packager.rsa.pub" \) -exec cp {} release-apks/ \;
        ls -lh release-apks/
    - name: Fetch GitHub-generated changelog
      id: gen-changelog
      run: |
        set -euo pipefail
        TAG="v${{ needs.prepare.outputs.resolved_version }}"
        API="https://api.github.com/repos/${{ github.repository }}/releases/generate-notes"
        echo "Requesting generated release notes for $TAG"
        RESPONSE=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${GITHUB_TOKEN}" -X POST -d "{\"tag_name\":\"$TAG\"}" "$API")
        echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('body',''))" > initial-release-notes.md || true
        if [ ! -s initial-release-notes.md ]; then
          echo "## Changelog" > initial-release-notes.md
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Generate release body (AMD64 only)
      id: release-body
      run: |
        set -euo pipefail
        VERSION="${{ needs.prepare.outputs.resolved_version }}"
        REPO="${{ github.repository }}"
        # Start with GitHub generated changelog
        if [ -f initial-release-notes.md ]; then
          cat initial-release-notes.md > release-body.md
        else
          echo "## Changelog" > release-body.md
        fi
        echo "## ðŸ“¦ modbus2mqtt v${VERSION}" >> release-body.md
        echo "" >> release-body.md
        echo "### ðŸ³ Docker Image" >> release-body.md
        echo "" >> release-body.md
        echo '    docker pull ghcr.io/'"${REPO}":v"${VERSION}" >> release-body.md
        echo "" >> release-body.md
        echo "**Multi-architecture support:** \\`linux/amd64\\`, \\`linux/arm64\\`" >> release-body.md
        echo "" >> release-body.md
        echo "### ðŸ“‹ Alpine APK (recommended)" >> release-body.md
        # Find AMD64 APK (file contains x86_64 or amd64)
        AMD_APK=$(ls release-apks/*x86_64*.apk 2>/dev/null | head -n1 || true)
        if [ -z "$AMD_APK" ]; then
          AMD_APK=$(ls release-apks/*amd64*.apk 2>/dev/null | head -n1 || true)
        fi
        if [ -n "$AMD_APK" ]; then
          AMD_FILE=$(basename "$AMD_APK")
          AMD_SIZE=$(ls -lh "$AMD_APK" | awk '{print $5}')
          AMD_LINK="https://github.com/${REPO}/releases/download/v${VERSION}/${AMD_FILE}"
        else
          AMD_FILE="(no AMD64 APK found)"
          AMD_SIZE="-"
          AMD_LINK="#"
        fi
        echo "- File: \\`${AMD_FILE}\\` (${AMD_SIZE})" >> release-body.md
        echo "- Direct download: [ðŸ“¥ Download](${AMD_LINK})" >> release-body.md
        echo "" >> release-body.md
        echo "### ðŸ” Package Verification" >> release-body.md
        echo "" >> release-body.md
        echo "Public Key for APK signature verification:" >> release-body.md
        echo "" >> release-body.md
        echo "- File: \\`packager.rsa.pub\\`" >> release-body.md
        echo "- Direct download: [ðŸ“¥ packager.rsa.pub](https://github.com/${REPO}/releases/download/v${VERSION}/packager.rsa.pub)" >> release-body.md
        echo "" >> release-body.md
        echo "Installation example (verify key first):" >> release-body.md
        echo "" >> release-body.md
        echo '        # Download and install public key' >> release-body.md
        echo '        wget https://github.com/'"${REPO}"'/releases/download/v'"${VERSION}"'/packager.rsa.pub' >> release-body.md
        echo '        sudo cp packager.rsa.pub /etc/apk/keys/' >> release-body.md
        echo "" >> release-body.md
        echo '    # Download & install the APK' >> release-body.md
        echo '    wget '"${AMD_LINK}" >> release-body.md
        echo '    sudo apk add ./'"${AMD_FILE}" >> release-body.md
        echo "" >> release-body.md
        echo "---" >> release-body.md
        echo "" >> release-body.md
        echo "Documentation: https://github.com/${REPO}/blob/main/README.md" >> release-body.md

        echo "Release body generated successfully"


    - name: Download APK artifacts for ${{ steps.platformcheck.outputs.arch }}
      uses: actions/download-artifact@v4
      with:
        name: apks-${{ steps.platformcheck.outputs.arch }}-${{ needs.prepare.outputs.resolved_version }}
        path: alpine/repo/${{ steps.platformcheck.outputs.arch }}
    - name: Download packager.rsa.pub artifact
      uses: actions/download-artifact@v4
      with:
        name: packager-rsa-pub-${{ needs.prepare.outputs.resolved_version }}
        path: alpine/repo/

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image for ${{ steps.platformcheck.outputs.platform }}
      env:
        VERSION: ${{ needs.prepare.outputs.resolved_version }}
        ARCH: ${{ steps.platformcheck.outputs.arch }}
        PLATFORM: ${{ steps.platformcheck.outputs.platform }}
      run: |
        set -eux
        TAG="ghcr.io/${{ github.repository }}-${PLATFORM}:v${VERSION}"
        echo "Building Docker image for $PLATFORM architecture..."
        docker build \
          --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          --build-arg BUILD_DESCRIPTION="modbus2mqtt Docker Image" \
          --build-arg BUILD_NAME="modbus2mqtt" \
          --build-arg BUILD_REPOSITORY="${{ github.repository }}" \
          --build-arg BUILD_VERSION="${VERSION}" \
          --build-arg BUILD_ARCH="${ARCH}" \
          -t "$TAG" \
          -f ./docker/Dockerfile \
          .
        echo "Pushing image: $TAG"
        docker push "$TAG"
        echo "âœ“ Built and pushed image $TAG"

  create_multiarch_manifest:
    runs-on: ubuntu-latest
    needs: [prepare, build_and_push_docker]
    outputs:
      image_tag: v${{ needs.prepare.outputs.resolved_version }}
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-architecture manifest
        env:
          VERSION: ${{ needs.prepare.outputs.resolved_version }}
        run: |
          set -eux
          MAIN_TAG="ghcr.io/${{ github.repository }}:v${VERSION}"
          AMD64_TAG="ghcr.io/${{ github.repository }}-amd64:v${VERSION}"
          ARM64_TAG="ghcr.io/${{ github.repository }}-arm64:v${VERSION}"
          
          echo "Creating multi-architecture manifest: $MAIN_TAG"
          docker buildx imagetools create -t "$MAIN_TAG" "$AMD64_TAG" "$ARM64_TAG"
          
          echo "âœ“ Created multi-architecture manifest: $MAIN_TAG"

  attach_release_assets:
    runs-on: ubuntu-latest
    needs: [prepare, build_apks, create_multiarch_manifest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all APK artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: apks-*-${{ needs.prepare.outputs.resolved_version }}
          path: apks
      - name: Download packager.rsa.pub artifact
        uses: actions/download-artifact@v4
        with:
          name: packager-rsa-pub-${{ needs.prepare.outputs.resolved_version }}
          path: release-apks/

      - name: Flatten APK artifacts for upload
        run: |
          mkdir -p release-apks
          find apks -type f \( -name "*.apk" -o -name "packager.rsa.pub" \) -exec cp {} release-apks/ \;
          ls -lh release-apks/

      - name: Fetch GitHub-generated changelog
        id: gen-changelog
        run: |
          set -euo pipefail
          TAG="v${{ needs.prepare.outputs.resolved_version }}"
          API="https://api.github.com/repos/${{ github.repository }}/releases/generate-notes"
          echo "Requesting generated release notes for $TAG"
          RESPONSE=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${GITHUB_TOKEN}" -X POST -d "{\"tag_name\":\"$TAG\"}" "$API")
          echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('body',''))" > initial-release-notes.md || true
          if [ ! -s initial-release-notes.md ]; then
            echo "## Changelog" > initial-release-notes.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release body (AMD64 only)
        id: release-body
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.resolved_version }}"
          REPO="${{ github.repository }}"

          # Start with GitHub generated changelog
          if [ -f initial-release-notes.md ]; then
            cat initial-release-notes.md > release-body.md
          else
            echo "## Changelog" > release-body.md
          fi
          echo "## ðŸ“¦ modbus2mqtt v${VERSION}" >> release-body.md
          echo "" >> release-body.md
          echo "### ðŸ³ Docker Image" >> release-body.md
          echo "" >> release-body.md
          echo '    docker pull ghcr.io/'"${REPO}":v"${VERSION}" >> release-body.md
          echo "" >> release-body.md
          echo "**Multi-architecture support:** \\`linux/amd64\\`, \\`linux/arm64\\`" >> release-body.md
          echo "" >> release-body.md
          echo "### ðŸ“‹ Alpine APK (recommended)" >> release-body.md

          # Find AMD64 APK (file contains x86_64 or amd64)
          AMD_APK=$(ls release-apks/*x86_64*.apk 2>/dev/null | head -n1 || true)
          if [ -z "$AMD_APK" ]; then
            AMD_APK=$(ls release-apks/*amd64*.apk 2>/dev/null | head -n1 || true)
          fi

          if [ -n "$AMD_APK" ]; then
            AMD_FILE=$(basename "$AMD_APK")
            AMD_SIZE=$(ls -lh "$AMD_APK" | awk '{print $5}')
            AMD_LINK="https://github.com/${REPO}/releases/download/v${VERSION}/${AMD_FILE}"
          else
            AMD_FILE="(no AMD64 APK found)"
            AMD_SIZE="-"
            AMD_LINK="#"
          fi

          echo "- File: \\`${AMD_FILE}\\` (${AMD_SIZE})" >> release-body.md
          echo "- Direct download: [ðŸ“¥ Download](${AMD_LINK})" >> release-body.md
          echo "" >> release-body.md
          echo "### ðŸ” Package Verification" >> release-body.md
          echo "" >> release-body.md
          echo "Public Key for APK signature verification:" >> release-body.md
          echo "" >> release-body.md
          echo "- File: \\`packager.rsa.pub\\`" >> release-body.md
          echo "- Direct download: [ðŸ“¥ packager.rsa.pub](https://github.com/${REPO}/releases/download/v${VERSION}/packager.rsa.pub)" >> release-body.md
          echo "" >> release-body.md
          echo "Installation example (verify key first):" >> release-body.md
          echo "" >> release-body.md
          echo '        # Download and install public key' >> release-body.md
          echo '        wget https://github.com/'"${REPO}"'/releases/download/v'"${VERSION}"'/packager.rsa.pub' >> release-body.md
          echo '        sudo cp packager.rsa.pub /etc/apk/keys/' >> release-body.md
          echo "" >> release-body.md
          echo '    # Download & install the APK' >> release-body.md
          echo '    wget '"${AMD_LINK}" >> release-body.md
          echo '    sudo apk add ./'"${AMD_FILE}" >> release-body.md
          echo "" >> release-body.md
          echo "---" >> release-body.md
          echo "" >> release-body.md
          echo "Documentation: https://github.com/${REPO}/blob/main/README.md" >> release-body.md

          echo "Release body generated successfully"

      - name: Upload to existing Release (if exists)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.resolved_version }}
          append_body: false
          body_path: release-body.md
          files: release-apks/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Notes:
# - dry_run=true allows local verification without pushing image or release assets.
# - Multi-arch APK builds (x86_64 + aarch64) use QEMU for cross-compilation.
# - Docker image builds with strict signature verification (no untrusted fallback).
# - This workflow is designed to be called from a publish workflow after version bump.
