name: 'On Pull Request: Enforce English in files'

on:
  pull_request:
    types: [opened, edited, synchronize]
  push:
    branches: ['**']
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  check-english:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine event context
        id: context
        run: |
          echo "EVENT_NAME=${GITHUB_EVENT_NAME}" >> $GITHUB_ENV
          echo "AFTER=${GITHUB_SHA}" >> $GITHUB_ENV
          if [ "${GITHUB_EVENT_NAME}" = "push" ]; then
            echo "BEFORE=${GITHUB_EVENT_BEFORE}" >> $GITHUB_ENV || true
          fi

      - name: Scan for non-English indicators
        id: scan
        env:
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail
          echo "Scanning commits / PR for non-English indicators..."

          # Patterns: German umlauts or sharp-s
          umlaut_pattern='[äöüÄÖÜß]'

          # A small set of common German words to detect obvious German text
          german_words='\b(und|der|die|das|nicht|bitte|Änderung|Änderungen|übersetz|deutsch|deutsche|ich|wir|Sie|dass)\b'

          matches=()

          if [ "${EVENT_NAME}" = "push" ]; then
            BEFORE=${BEFORE:-}
            AFTER=${AFTER}
            if [ -n "$BEFORE" ] && git rev-parse "$BEFORE" >/dev/null 2>&1; then
              range="$BEFORE..$AFTER"
            else
              range="$AFTER"
            fi

            # Scan changed .md/.yml/.yaml/.json files for obvious German words (added/modified lines)
            changed_files=$(git diff --name-only "$range" -- '*.md' '*.yml' '*.yaml' '*.json' || true)
            for f in $changed_files; do
              if git diff "$range" -- "$f" | grep -E "^[+].*($umlaut_pattern|$german_words)" -i >/dev/null 2>&1; then
                matches+=("file:$f")
              fi
            done

          else
            # pull_request event: scan changed files
            if [ -n "${PR_BASE_SHA:-}" ] && [ -n "${PR_HEAD_SHA:-}" ]; then
              range="${PR_BASE_SHA}..${PR_HEAD_SHA}"
              # Scan changed .md/.yml/.yaml/.json files for obvious German words (added/modified lines)
              changed_files=$(git diff --name-only "$range" -- '*.md' '*.yml' '*.yaml' '*.json' || true)
              for f in $changed_files; do
                if git diff "$range" -- "$f" | grep -E "^[+].*($umlaut_pattern|$german_words)" -i >/dev/null 2>&1; then
                  matches+=("file:$f")
                fi
              done
            fi
          fi

          if [ ${#matches[@]} -gt 0 ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "matches=${matches[*]}" >> $GITHUB_OUTPUT
            echo "Matches: ${matches[*]}"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "Matches: none"
          fi

      - name: Report and fail / comment on PR
        if: steps.scan.outputs.found == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const matches = `${{ steps.scan.outputs.matches }}`
            const repo = context.repo
            const event = process.env.GITHUB_EVENT_NAME
            const body = `⚠️ Please use English for repository changes. Detected potential non-English content in: ${matches}`

            if (event === 'pull_request') {
              const pr = context.payload.pull_request.number
              core.info(`Commenting on PR #${pr}`)
              await github.rest.issues.createComment({ owner: repo.owner, repo: repo.repo, issue_number: pr, body })
              core.setFailed('Non-English content detected in files; please update to use English.')
            } else {
              // For pushes, fail the workflow
              core.setFailed(`Non-English content detected in files: ${matches}. Please ensure changes are in English.`)
            }
