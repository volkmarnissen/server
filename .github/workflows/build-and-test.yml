name: Build and Test APK

# Configures this workflow to run every time a change is pushed to the branch called `release`.
on:
#  push:
#    branches: ['main']
  workflow_dispatch:
    inputs:
      version_number:
        description: Version number <patch|minor| version number(E.g. 1.0.0) see npm version> An empty version number doesn't change the version
        default: ''
      job:
        type: choice
        description: Select job to execute
        options: 
        - npm_publish
        - docker
        - all
        default: 'all'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Ensure Docker is available
        run: docker --version

      - name: Run build and test
        env:
          PACKAGER_PRIVKEY: ${{ secrets.PACKAGER_PRIVKEY }}
          PACKAGER_PUBKEY: ${{ env.PACKAGER_PUBKEY }}
        run: |
          cd alpine-package/modbus2mqtt
          chmod +x build.sh build-and-test-image.sh
          ./build-and-test-image.sh
      - name: Check in alpine Repository
        uses: stefanzweifel/git-auto-commit-action@v4
        with: 
          commit_message: 'Check in alpine Repository'
          file_pattern: 'alpine-repo/*/*'

