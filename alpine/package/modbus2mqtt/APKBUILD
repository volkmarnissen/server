# shellcheck shell=sh 
# shellcheck disable=SC2034
# shellcheck disable=SC2154
# Contributor: Modbus2mqtt <info@carcam360.de>
# Maintainer: Modbus2mqtt <info@carcam360.de>
pkgname=modbus2mqtt
# Version comes from package.json or the PKG_VERSION environment variable
pkgver=0.16.56
pkgrel=0
pkgdesc="Modbus to MQTT bridge"
url="https://github.com/volkmarnissen/server"
arch="$CARCH"
license="MIT"
depends="nodejs npm s6-overlay git"
makedepends="npm alpine-sdk shadow rsync py3-psutil make build-base linux-headers udev"
install="$pkgname.pre-install $pkgname.post-install"

# Disable the abuild check phase: tests are executed in the GitHub workflow
# (before creating the npm artifacts and after installing the produced APK),
# so running the check() step inside the APK build would be redundant and
# may run at the wrong moment. Use the options variable to skip it.
options="!check"
source=""
builddir="$srcdir/$pkgname-$pkgver"

build() {
    # Build modbus2mqtt within the abuild build environment so native
    # modules are compiled for the target architecture.
    mkdir -p "$builddir"
    cd "$builddir" || exit 1
    # Copy package.json from the repository so npm can install the
    # published package into the builddir. abuild typically cleans
    # $srcdir before running build(), so prefer the checkout at the
    # parent of the packaging dir (startdir/../package.json) when
    # available. Fall back to $srcdir/package.json and finally to a
    # minimal package.json.
    npm init -y >/dev/null 2>&1 || true
    
    # Install main package with suppressed output (show only on error)
    echo "Installing ${pkgname}@${pkgver}..."
    npm_log=$(mktemp)
    if ! npm install --force --no-audit --no-fund --omit=dev "${pkgname}@${pkgver}" >"$npm_log" 2>&1; then
        echo "ERROR: npm install failed" >&2
        cat "$npm_log" >&2
        rm -f "$npm_log"
        exit 1
    fi
    rm -f "$npm_log"
    
    # Remove prebuilt binaries first to force rebuild from source
    find node_modules -type d -name "prebuilds" -prune -print -exec rm -rf '{}' + || true
    
    # Install build tools for native module compilation
    echo "Installing build tools..."
    build_log=$(mktemp)
    if ! npm install --save-dev node-gyp node-gyp-build >"$build_log" 2>&1; then
        echo "WARNING: Failed to install build tools" >&2
        cat "$build_log" >&2
    fi
    rm -f "$build_log"
    
    # Rebuild all native modules from source for target architecture
    # Find all packages with binding.gyp (indicator for native modules)
    find node_modules -name "binding.gyp" -type f | while read -r gyp_file; do
        module_dir=$(dirname "$gyp_file")
        module_name=$(basename "$module_dir")
        echo "Rebuilding native module: $module_name"
        cd "$module_dir" || continue
        
        # Capture node-gyp output; only show on error
        log_file=$(mktemp)
        if ! node-gyp rebuild >"$log_file" 2>&1; then
            echo "WARNING: Failed to rebuild $module_name" >&2
            cat "$log_file" >&2
        fi
        rm -f "$log_file"
        
        cd "$builddir" || exit 1
    done
    
    # Uninstall build tools quietly
    echo "Cleaning up build tools..."
    npm uninstall node-gyp node-gyp-build >/dev/null 2>&1 || true
}

package() {
    # Install application files
    install -d "$pkgdir"/usr/lib/$pkgname
    # Copy the node_modules package from the builddir (ensures target-arch binaries)
    mkdir -p "$pkgdir"/usr/lib
    rsync -au "$builddir"/node_modules "$pkgdir"/usr/lib
   
    # Create symlink to the executable
    install -d "$pkgdir"/usr/bin
    ln -s /usr/lib/node_modules/$pkgname/bin/$pkgname "$pkgdir"/usr/bin/$pkgname
    # Create config directory
    install -d "$pkgdir"/etc/$pkgname
    # create homeassistant addon directories
    install -d "$pkgdir"/config
    install -d "$pkgdir"/data
    install -d "$pkgdir"/ssl
    # Do not chown to the service user here (user may not exist inside fakeroot).
    # Permissions should be set here; user is created at install time in pre-install.
    chmod 755 "$pkgdir"/config "$pkgdir"/data "$pkgdir"/ssl
}

