#!/bin/sh

# Port-Liste definieren
DEFAULT_PORTS="3001 3003 3004 3005 3007"
ALL_PORTS="$DEFAULT_PORTS 3002 3006"

if [ "$#" -gt 0 ] && [ "$1" = "all" ]; then
  PORTS="$ALL_PORTS"
else
  PORTS="$DEFAULT_PORTS"
fi

# Build grep pattern
GREP_PATTERN=""
for port in $PORTS; do
  GREP_PATTERN="$GREP_PATTERN -e :$port"
done

MAX_ATTEMPTS=5
attempt=0
echo "grep pattern $GREP_PATTERN"
while [ $attempt -lt $MAX_ATTEMPTS ]; do
  attempt=$((attempt + 1))
  
  # Process-List in Variable speichern (vermeidet Subshell-Problem)
  # shellcheck disable=SC2086
  PROCESS_LIST=$(lsof -i -P -u "$(id -u)" 2>/dev/null | grep LISTEN | grep $GREP_PATTERN | awk '{print $2, $1, $3}' | sort -u)
  
  if [ -z "$PROCESS_LIST" ]; then
    echo "All test servers stopped" >&2
    exit 0
  fi
  
  echo "$PROCESS_LIST" | while read -r PID NAME USER; do
    if [ -n "$PID" ] && [ "$PID" -gt 0 ]; then
      PARENT_PID=$(ps -p "$PID" -o "ppid=" 2>/dev/null | tr -d ' ')
      
      if [ -n "$PARENT_PID" ] && [ "$PARENT_PID" -gt 0 ]; then
        PARENT_OWNER=$(ps -p "$PARENT_PID" -o "uid=" 2>/dev/null | tr -d ' ')
        
        if [ -n "$PARENT_OWNER" ] && [ "$PARENT_OWNER" -eq "$(id -u)" ]; then
          if kill -2 "$PARENT_PID" 2>/dev/null; then
            echo "Sent SIGINT to parent $PARENT_PID of $NAME" >&2
            sleep 0.2
          fi
        fi
      fi
      
      if kill "$PID" 2>/dev/null; then
        echo "Sent SIGTERM to $NAME (PID: $PID)" >&2
      else
        echo "Failed to kill $NAME (PID: $PID)" >&2
      fi
    fi
  done
  
  sleep 1
done

# PrÃ¼fe ob noch Prozesse laufen
# shellcheck disable=SC2086
REMAINING=$(lsof -i -P -u "$(id -u)" 2>/dev/null | grep LISTEN | grep $GREP_PATTERN | awk '{print $2, $9}' | sort -u)

if [ -n "$REMAINING" ]; then
  echo "ERROR: Failed to stop all test servers after $MAX_ATTEMPTS attempts" >&2
  echo "Still running:" >&2
  echo "$REMAINING" >&2
  exit 1
else
  echo "All test servers stopped successfully" >&2
  exit 0
fi